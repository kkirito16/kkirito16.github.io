<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>前端版本更新提示技术方案调研与实现 | 仰望星空时</title><meta name="author" content="KKirito,2021090917010@std.uestc.edu.cn"><meta name="copyright" content="KKirito"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前端版本更新提示技术方案调研与实现需求场景项目迭代频繁，如果用户打网页后，长时间不关闭对应标签页，也不刷新页面，而此期间有新的版本已经上线了，需要用户手动刷新，不然会出现一直使用旧版本以及会出现一些不可预知的错误 实现思路 采取定时检查，定期向服务器发送请求，检查是否有新版本可用。 拦截页面的网络请求，并且在发现有新版本时，提示用户更新或者自动更新。 通过WebSocket连接实时接收到服务器的推">
<meta property="og:type" content="article">
<meta property="og:title" content="前端版本更新提示技术方案调研与实现">
<meta property="og:url" content="https://ljqkkirito16.top/2024/08/06/%E5%89%8D%E7%AB%AF%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%8F%90%E7%A4%BA%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94%E4%B8%8E%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="仰望星空时">
<meta property="og:description" content="前端版本更新提示技术方案调研与实现需求场景项目迭代频繁，如果用户打网页后，长时间不关闭对应标签页，也不刷新页面，而此期间有新的版本已经上线了，需要用户手动刷新，不然会出现一直使用旧版本以及会出现一些不可预知的错误 实现思路 采取定时检查，定期向服务器发送请求，检查是否有新版本可用。 拦截页面的网络请求，并且在发现有新版本时，提示用户更新或者自动更新。 通过WebSocket连接实时接收到服务器的推">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.imgdb.cn/item/64e18125661c6c8e54c33269.jpg">
<meta property="article:published_time" content="2024-08-06T06:24:01.192Z">
<meta property="article:modified_time" content="2024-08-06T06:24:27.562Z">
<meta property="article:author" content="KKirito">
<meta property="article:tag" content="Markdown">
<meta property="article:tag" content="前端">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/64e18125661c6c8e54c33269.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ljqkkirito16.top/2024/08/06/%E5%89%8D%E7%AB%AF%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%8F%90%E7%A4%BA%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94%E4%B8%8E%E5%AE%9E%E7%8E%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":50},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '前端版本更新提示技术方案调研与实现',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-06 14:24:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/64e18125661c6c8e54c33269.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/64e180ea661c6c8e54c28a1c.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="仰望星空时"><span class="site-name">仰望星空时</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">前端版本更新提示技术方案调研与实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-06T06:24:01.192Z" title="发表于 2024-08-06 14:24:01">2024-08-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-06T06:24:27.562Z" title="更新于 2024-08-06 14:24:27">2024-08-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/">技术文档</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="前端版本更新提示技术方案调研与实现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前端版本更新提示技术方案调研与实现"><a href="#前端版本更新提示技术方案调研与实现" class="headerlink" title="前端版本更新提示技术方案调研与实现"></a>前端版本更新提示技术方案调研与实现</h1><h2 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景"></a>需求场景</h2><p>项目迭代频繁，如果用户打网页后，长时间不关闭对应标签页，也不刷新页面，而此期间有新的版本已经上线了，需要用户手动刷新，不然会出现一直使用旧版本以及会出现一些不可预知的错误</p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><ul>
<li>采取定时检查，定期向服务器发送请求，检查是否有新版本可用。</li>
<li>拦截页面的网络请求，并且在发现有新版本时，提示用户更新或者自动更新。</li>
<li>通过<code>WebSocket</code>连接实时接收到服务器的推送消息，如果有新版本可用，服务器可以通过<code>WebSocket</code>发送通知给客户端，提醒用户刷新页面。</li>
</ul>
<h2 id="主流实现方案"><a href="#主流实现方案" class="headerlink" title="主流实现方案"></a>主流实现方案</h2><h3 id="方案一-通过-ETag-获取应用版本"><a href="#方案一-通过-ETag-获取应用版本" class="headerlink" title="方案一 通过 ETag 获取应用版本"></a>方案一 通过 ETag 获取应用版本</h3><p><code>&quot;ETag&quot;(Entity Tag)</code>是HTTP标头的一部分，用于标识网络资源的版本。它通常与<code>HTTP</code>缓存机制一起使用，以便客户端可以在后续请求中使用<code>ETag</code>来检查资源是否已经发生了变化。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722917837011.png" alt="1722917837011"></p>
<h4 id="ETag的生成"><a href="#ETag的生成" class="headerlink" title="ETag的生成"></a>ETag的生成</h4><ul>
<li><p>对于静态文件(如css、js、图片等)，<code>ETag</code>的生成策略是:文件大小的16进制+修改时间</p>
</li>
<li><p>对于字符串或<code>Buffer</code>，<code>ETag</code>的生成策略是:字符串&#x2F;<code>Buffer</code>长度的16进制+对应的<code>hash</code>值</p>
</li>
</ul>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><p>我们可以通过 <code>fetch</code> 请求获取当前应用的 <code>etag</code> 标签:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(location.<span class="property">href</span>, &#123;<span class="attr">method</span>: <span class="string">&#x27;HEAD&#x27;</span>,<span class="attr">cache</span>: <span class="string">&#x27;no-cache&#x27;</span>&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;etag&#x27;</span>))&#125;)</span><br></pre></td></tr></table></figure>

<p>当应用新版本发布后， <code>etag</code> 的值也会更新。所以，我们可以通过比较 <code>etag</code> 的值来判断是否有新版本发布。</p>
<p>通过<code>Web Worker</code>来轮询最新的ETag:</p>
<p><code>version-worker.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">self.<span class="property">onmessage</span>=<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">    /!获取当前版本的<span class="title class_">ETag</span>值currentETag</span><br><span class="line">    <span class="keyword">const</span> currentETag = e.<span class="property">data</span>.<span class="property">currentETag</span></span><br><span class="line">    <span class="comment">// 设置定时器，每隔3秒向指定的checkurl发送HEAD请求//当服务器返回的ETag值与currentETag不相同时，向主线程发送消息&#x27;has new version&#x27;setInterval(()=&gt;&#123;</span></span><br><span class="line">    <span class="title function_">fetch</span>(e.<span class="property">data</span>.<span class="property">checkUrl</span>,&#123;<span class="attr">method</span>: <span class="string">&#x27;HEAD&#x27;</span></span><br><span class="line">                           <span class="attr">cache</span>:<span class="string">&#x27;no-cache</span></span><br><span class="line"><span class="string">                          &#125;).then((res)=&gt;&#123;if(res.headers.get(&#x27;</span>etag<span class="string">&#x27;)!= currentETag)&#123;self.postMessage(&#x27;</span>has <span class="keyword">new</span> version<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">                                                                                    子)</span></span><br><span class="line"><span class="string">                                                                                   &#125;，3000)</span></span><br></pre></td></tr></table></figure>

<p>主页代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 创建worker</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> myWorker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;version-worker.js&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 接收版本⽐较结果</span></span></span><br><span class="line"><span class="language-javascript">            myWorker.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                myWorker.<span class="title function_">terminate</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> result = <span class="title function_">confirm</span>(<span class="string">&#x27;有新版本，是否更新&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (result) &#123;</span></span><br><span class="line"><span class="language-javascript">                    location.<span class="title function_">reload</span>()</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 获取当前版本并发送给worker</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fetch</span>(location.<span class="property">href</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;HEAD&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">cache</span>: <span class="string">&#x27;no-cache&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                myWorker.<span class="title function_">postMessage</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">checkUrl</span>: location.<span class="property">href</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">currentETag</span>: res.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;etag&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>主页面获取当前 <code>etag</code> 值后，发送消息给 <code>worker</code> ， <code>worker</code> 将会异步的定时请求最新的<code>etag</code>值，并进行比较，当<code>etag</code>值不⼀致时会发送消息给主页。主页面接受到新版本发布消息后，可对用户进行提醒。</p>
<h4 id="相关第三方组件version-polling"><a href="#相关第三方组件version-polling" class="headerlink" title="相关第三方组件version-polling"></a>相关第三方组件<code>version-polling</code></h4><blockquote>
<p>仓库地址：<a target="_blank" rel="noopener" href="https://github.com/JoeshuTT/version-polling">https://github.com/JoeshuTT/version-polling</a></p>
<p>安装： npm install version-polling –save</p>
</blockquote>
<h5 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h5><ol>
<li>使用<code> Web Worker APl</code>在浏览器后台轮询请求页面，不会影响主线程运行。</li>
<li>命中协商缓存，对比本地和服务器请求响应头<code>etag</code>字段值。</li>
<li>如果 <code>etag</code> 值不一致，说明有更新，则弹出更新提示，并引导用户手动刷新页面(例如弹窗提示)，完成应用更新。</li>
<li>当页面不可见时(例如切换标签页或最小化窗口)，停止实时检测任务;再次可见时(例如切换回标签页或还原窗口)，恢复实时检测任务。</li>
</ol>
<h5 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h5><h6 id="方法一-通过-npm-引入，并通过构建工具进行打包"><a href="#方法一-通过-npm-引入，并通过构建工具进行打包" class="headerlink" title="方法一 通过 npm 引入，并通过构建工具进行打包"></a>方法一 通过 <code>npm</code> 引入，并通过构建工具进行打包</h6><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在应用入口文件中使用:如 main.js，app.jsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; createVersionPolling &#125; <span class="keyword">from</span> <span class="string">&quot;version-polling&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">createVersionPolling</span>(&#123;</span><br><span class="line">    <span class="attr">appETagKey</span>:<span class="string">&quot;_APP_ETAG__&quot;</span>,</span><br><span class="line">    <span class="attr">pollingInterval</span>:<span class="number">5</span>*<span class="number">1000</span>，<span class="comment">//单位为毫秒</span></span><br><span class="line">    <span class="attr">silent</span>:process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ===<span class="string">&quot;development&quot;</span>，<span class="comment">//开发环境下不检测</span></span><br><span class="line">    <span class="attr">onUpdate</span>:<span class="function">(<span class="params">self</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//当检测到有新版本时，执行的回调函数，可以在这里提示用户刷新页面</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="title function_">confirm</span>(<span class="string">&quot;页面有更新，点击确定刷新页面!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(result)&#123;</span><br><span class="line">        self.<span class="title function_">onRefresh</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        self.<span class="title function_">oncancel</span>();</span><br><span class="line">        <span class="comment">//强制更新可以用alert</span></span><br><span class="line">        <span class="comment">// alert(&#x27;有新版本，请刷新页面”);</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h6 id="方法二-通过-script-引⼊，直接插⼊到-HTML（无侵入用法，接入成本最低）"><a href="#方法二-通过-script-引⼊，直接插⼊到-HTML（无侵入用法，接入成本最低）" class="headerlink" title="方法二 通过 script 引⼊，直接插⼊到 HTML（无侵入用法，接入成本最低）"></a>方法二 通过<code> script</code> 引⼊，直接插⼊到 <code>HTML</code>（无侵入用法，接入成本最低）</h6><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>前端页面自动检测更新<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//unpkg.com/version-polling/dist/version-polling.min.js&quot;</span>&gt;</span><span class="language-handlebars"><span class="language-xml">&lt;/scri</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                <span class="title class_">VersionPolling</span>.<span class="title function_">createVersionPolling</span>(&#123;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                <span class="attr">appETagKey</span>: <span class="string">&quot;__APP_ETAG__&quot;</span>,</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                <span class="attr">pollingInterval</span>: <span class="number">5</span> * <span class="number">1000</span>,</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                <span class="attr">onUpdate</span>: <span class="function">(<span class="params">self</span>) =&gt;</span> &#123;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                    <span class="comment">// 当检测到有新版本时，执⾏的回调函数，可以在这里页面</span></span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                    <span class="keyword">const</span> result = <span class="title function_">confirm</span>(<span class="string">&quot;页面有更新，点击确定刷新页面！&quot;</span>);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                    <span class="keyword">if</span> (result) &#123;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                        self.<span class="title function_">onRefresh</span>();</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                    &#125; <span class="keyword">else</span> &#123;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                        self.<span class="title function_">onCancel</span>();</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                    &#125;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">                &#125;,</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">            &#125;);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">        </span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>version-polling 需要在⽀持 web worker 和 fetchAPI 的浏览器中运⾏，不⽀持 IE 浏览器</li>
<li>version-polling 需要在 web 应⽤的⼊⼝⽂件（通常是 index.html）中引⼊，否则⽆法检测到更新</li>
<li>version-polling 需要在 web 应⽤的服务端配置协商缓存，否则⽆法命中缓存，会增加⽹络请求</li>
<li>version-polling 需要在 web 应⽤的服务端保证每次发版后，index.html ⽂件的 etag 字段值会改变，否则⽆法检测到更新</li>
</ul>
<h4 id="方案缺陷"><a href="#方案缺陷" class="headerlink" title="方案缺陷"></a>方案缺陷</h4><ul>
<li><p><strong>频繁的轮询请求，且每次请求Size大</strong>:即使应用程序没有更新也会消耗网络带宽和服务器资源，可能会对性能产生负面影响，尤其是在大量用户同时访问的情况下。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722921251786.png"></p>
</li>
<li><p><strong>无法实时推送更新：</strong>使用轮询方式无法实现实时推送更新的功能。轮询方式通常有一定的时间间隔，用户只能等待下一次轮询请求才能收到更新通知。这种延迟可能会导致用户错过重要的更新或者在使用过时版本时遇到问题。</p>
</li>
</ul>
<h3 id="方案二-提取版本号保存至json文件，客户端轮询服务器上的版本号"><a href="#方案二-提取版本号保存至json文件，客户端轮询服务器上的版本号" class="headerlink" title="方案二 提取版本号保存至json文件，客户端轮询服务器上的版本号"></a>方案二 提取版本号保存至json文件，客户端轮询服务器上的版本号</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722921319728.png" alt="1722921319728"></p>
<p>以 <code>git commit hash</code>(也支持<code>svn revision number</code>、<code>package.json version.build timestamp </code>、<code>custom</code>)为版本号，打包时将版本号写入一个 <code>json</code>文件，同时注入客户端运行的代码。客户端轮询服务器上的版本号（浏览器窗口的<code>visibilitychange</code>、<code>focus</code> 事件辅助)，和本地作比较，如果不相同则通知用户刷新页面。</p>
<h4 id="相关第三方组件-plugin-web-update-notification"><a href="#相关第三方组件-plugin-web-update-notification" class="headerlink" title="相关第三方组件 plugin-web-update-notification"></a>相关第三方组件 <code>plugin-web-update-notification</code></h4><blockquote>
<p>仓库:<a target="_blank" rel="noopener" href="https://github,com/GreatAuk/plugin-web-update-notification">https://github,com/GreatAuk/plugin-web-update-notification</a></p>
<p>安装:(可以使用npm安装)</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vite</span></span><br><span class="line">pnpm add @plugin<span class="literal">-web-update-notification</span>/vite <span class="literal">-D</span></span><br><span class="line"><span class="comment"># umijs</span></span><br><span class="line">pnpm add @plugin<span class="literal">-web-update-notification</span>/umijs <span class="literal">-D</span></span><br><span class="line"><span class="comment"># webpack plugin</span></span><br><span class="line">pnpm add @plugin<span class="literal">-web-update-notification</span>/webpack <span class="literal">-D</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul>
<li>接入简单，安装插件，修改配置文件即可，不用修改业务代码(如果不自定义行为)</li>
<li>支持多种版本号类型(<code>git commit hash</code>、<code>svn revision number</code>、<code>package.js</code>中的 <code>version</code> 字段、 <code>build timestamp</code> 运行打包命令时的时间戳、<code>custom</code> 用户自定义版本可以自定义更新提示的文案、样式、位置，且支持多语言，也可以取消默认的 <code>Notification</code>,监听到更新事件后自定义行为。</li>
<li>支持手动控制检测</li>
<li>注入的<code> js</code> 和<code>css</code> 文件压缩后不到2kb</li>
<li>完善的 <code>ts</code> 类型提示</li>
<li><code>issue</code> 响应即时</li>
</ul>
<h5 id="基于项目的实践项目采用vue-cli进行打包"><a href="#基于项目的实践项目采用vue-cli进行打包" class="headerlink" title="基于项目的实践项目采用vue-cli进行打包"></a>基于项目的实践项目采用<code>vue-cli</code>进行打包</h5><p>安装第三方组件后，在 <code>vue.config.js</code> 文件中加入:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">WebUpdateNotificationPlugin</span> &#125; = <span class="built_in">require</span>(@plugin-web-update-notification/vite<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">const &#123; defineConfig &#125; = require(&#x27;</span>@vue/cli-service<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">module.exports = &#123;</span></span><br><span class="line"><span class="string">    // ...other config</span></span><br><span class="line"><span class="string">    configureWebpack: &#123;</span></span><br><span class="line"><span class="string">        resolve: &#123;</span></span><br><span class="line"><span class="string">            // ...other config</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        plugins: [</span></span><br><span class="line"><span class="string">            new WebUpdateNotificationPlugin(&#123;</span></span><br><span class="line"><span class="string">                logVersion: true,</span></span><br><span class="line"><span class="string">                versionType: &#x27;</span>git_commit_hash<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                checkInterval: 0.5 * 60 * 1000,</span></span><br><span class="line"><span class="string">                checkOnWindowFocus: true,</span></span><br><span class="line"><span class="string">                checkImmediately: true,</span></span><br><span class="line"><span class="string">                checkOnLoadFileError: true,</span></span><br><span class="line"><span class="string">                notificationConfig: &#123;</span></span><br><span class="line"><span class="string">                    placement: &#x27;</span>topRight<span class="string">&#x27;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                notificationProps: &#123;</span></span><br><span class="line"><span class="string">                    title: &#x27;</span>页面已经发生了更新<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                    description: &#x27;</span>检测到当前页面内容已经发生了更新，请刷新页面后使用<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                    buttonText: &#x27;</span>刷新<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                    dismissButtonText: &#x27;</span>忽略<span class="string">&#x27;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">            &#125;),</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h6><p>运行打包命令 <code>yarn run build</code></p>
<p>dist目录下多了⼀个⽂件夹，包含含有版本号的<code>JSON</code>文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722923207539.png" alt="1722923207539"></p>
<p>更新提示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/image-20240806140346695.png" alt="image-20240806140346695"></p>
<h6 id="检测更新的时机"><a href="#检测更新的时机" class="headerlink" title="检测更新的时机"></a>检测更新的时机</h6><ol>
<li>首次加载页面。</li>
<li>轮询(default:10 * 60 * 1000 ms)</li>
<li>js 脚本资源加载失败 (404 ?)</li>
<li>标签页 <code>visibilitychange</code>、<code>focus</code> 事件为<code> true</code> 时。</li>
</ol>
<h4 id="自实现方法"><a href="#自实现方法" class="headerlink" title="自实现方法"></a>自实现方法</h4><h5 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h5><ol>
<li>用 <code>git</code> 命令提取当前最新的 <code>cmt id</code></li>
<li>把 <code>cmt id</code> 写入到一个文件里，这个文件会被轮询</li>
<li>把 <code>cmt id</code> 写入到 <code>index.html</code>里</li>
<li>在 <code>main.js</code> 里去轮询写入了 <code>cmt id</code> 的文件，拿来和 <code>html</code> 里进行对比</li>
<li>如果 <code>html</code> 存在 <code>cmt id</code> ，且轮询到了<code>cmt id</code> ，然后两个 <code>cmt id</code> 不相等，则提示更新</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722923475645.png" alt="1722923475645"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722923497761.png" alt="1722923497761"></p>
<h5 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h5><p>通过<code>git</code>命令将最新的<code>cmt id</code> 注入<code>latest_commit id.txt</code> 文件中:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">git rev<span class="literal">-parse</span> HEAD &gt; latest_commit_id.txt</span><br></pre></td></tr></table></figure>

<p>编写 <code>html/updateIndex.js</code> <code>node</code> 脚本文件，用于动态获取 <code>commit id</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; execSync &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="comment">// 使⽤ git 命令获取最新 commit id</span></span><br><span class="line"><span class="keyword">const</span> latestCommitId = <span class="title function_">execSync</span>(<span class="string">&#x27;git rev-parse HEAD&#x27;</span>).<span class="title function_">toString</span>().<span class="title function_">trim</span>();</span><br><span class="line"><span class="comment">// 将最新 commit id 写⼊ index.html ⽂件</span></span><br><span class="line"><span class="keyword">let</span> indexHtml = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./index.html&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">indexHtml = indexHtml.<span class="title function_">replace</span>(</span><br><span class="line"><span class="string">&#x27;window.latestCommitId = &quot;&quot;;&#x27;</span>,</span><br><span class="line"><span class="string">`window.latestCommitId = &quot;<span class="subst">$&#123;latestCommitId&#125;</span>&quot;;`</span></span><br><span class="line">);</span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(<span class="string">&#x27;index.html&#x27;</span>, indexHtml);</span><br><span class="line"><span class="comment">// 将最新 commit id 写⼊ latest_commit_id.txt ⽂件</span></span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(<span class="string">&#x27;latest_commit_id.txt&#x27;</span>, latestCommitId);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;最新 commit id 已插⼊到 index.html 和 latest_commit_id.txt ⽂件中。&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>并加入在 <code>package.json</code> 打包命令中：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service serve &amp;&amp; node ./html/updateIndex.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service build &amp;&amp; node ./html/updateIndex.js&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>编辑 <code>html/index.html</code> 文件，加入轮询代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">latestCommitId</span> = <span class="string">&quot;&quot;</span>; <span class="comment">// 替换为动态获取的 commit id</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加 <code>src/common/updateCheck.js</code> 文件，进行轮询操作：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UpdateModal</span> <span class="keyword">from</span> <span class="string">&#x27;./UpdateModal.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ⽴即查询⼀次最新的 commit ID</span></span><br><span class="line">    <span class="title function_">fetchLatestCommitId</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置定时器，每隔10分钟查询⼀次最新的 commit ID</span></span><br><span class="line">    <span class="built_in">setInterval</span>(fetchLatestCommitId, <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchLatestCommitId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;/latest_commit_id.txt&#x27;</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">newCommitId</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> currentCommitId = <span class="variable language_">window</span>.<span class="property">latestCommitId</span></span><br><span class="line">        <span class="keyword">if</span> (currentCommitId &amp;&amp; currentCommitId !== newCommitId) &#123;</span><br><span class="line">            <span class="comment">// 提⽰更新</span></span><br><span class="line">            <span class="title function_">showUpdateModal</span>(newCommitId)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showUpdateModal</span>(<span class="params">newCommitId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">UpdateModalComponent</span> = <span class="title class_">Vue</span>.<span class="title function_">extend</span>(<span class="title class_">UpdateModal</span>)</span><br><span class="line">    <span class="keyword">const</span> updateModalInstance = <span class="keyword">new</span> <span class="title class_">UpdateModalComponent</span>(&#123;</span><br><span class="line">        <span class="attr">propsData</span>: &#123; newCommitId &#125;,</span><br><span class="line">        <span class="attr">methods</span>: &#123;</span><br><span class="line">            <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.$destroy()</span><br><span class="line">                div.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(div)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_">refresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>(<span class="literal">true</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    updateModalInstance.$mount(div)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了 <code>DOMContentLoaded</code> 来确保在操作页面元素之前等待页面加载完成</p>
<p>可见只轮询一个txt文件size要小很多</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/image-20240806135721956.png" alt="image-20240806135721956"></p>
<p>添加 <code>updateModal.vue</code> 文件，编写弹框的样式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;div class=&quot;update-modal&quot; v-if=&quot;!isClosed&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;title&quot;&gt;发现新版本&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;content&quot;&gt;⽹⻚更新啦！请刷新⻚⾯后使⽤&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">        &lt;a @click=&quot;ignore&quot; class=&quot;web-update-notice-refresh-btn&quot;&gt;忽略&lt;/a&gt;</span><br><span class="line">        &lt;a @click=&quot;refresh&quot; class=&quot;web-update-notice-dismiss-btn&quot;&gt;刷新&lt;/a&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    export default &#123;</span><br><span class="line">        props: &#123;</span><br><span class="line">            newCommitId: &#123;</span><br><span class="line">                type: String,</span><br><span class="line">                required: true,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                isClosed: false,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            ignore() &#123;</span><br><span class="line">                this.isClosed = true // 设置 isClosed 为 true 以关闭模态框</span><br><span class="line">                this.$emit(&#x27;close&#x27;)</span><br><span class="line">            &#125;,</span><br><span class="line">            refresh() &#123;</span><br><span class="line">                this.$emit(&#x27;refresh&#x27;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .update-modal &#123;</span><br><span class="line">        position: fixed;</span><br><span class="line">        bottom: 15%;</span><br><span class="line">        right: 3%;</span><br><span class="line">        background-color: #fff;</span><br><span class="line">        border-radius: 10px;</span><br><span class="line">        color: #000000d9;</span><br><span class="line">        border: 1px solid rgba(0, 0, 0, 0.1); /* 添加边框 */</span><br><span class="line">        padding: 8px 16px;</span><br><span class="line">        line-height: 1.5715;</span><br><span class="line">        width: 280px;</span><br><span class="line">        z-index: 9999;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .update-modal .title &#123;</span><br><span class="line">        font-weight: 500;</span><br><span class="line">        margin-bottom: 4px;</span><br><span class="line">        font-size: 16px;</span><br><span class="line">        line-height: 24px;</span><br><span class="line">        text-align: left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .update-modal .content &#123;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        margin-bottom: 20px;</span><br><span class="line">        text-align: left;</span><br><span class="line">    &#125;</span><br><span class="line">    .actions &#123;</span><br><span class="line">        margin-top: 4px;</span><br><span class="line">        text-align: right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .update-modal .actions a &#123;</span><br><span class="line">        padding: 3px 8px;</span><br><span class="line">        line-height: 1;</span><br><span class="line">        transition: background-color 0.2s linear;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .update-modal .actions a:hover &#123;</span><br><span class="line">        background-color: rgba(64, 87, 109, 0.1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .update-modal .actions .web-update-notice-refresh-btn &#123;</span><br><span class="line">        color: rgba(0, 0, 0, 0.25);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .update-modal .actions .web-update-notice-dismiss-btn &#123;</span><br><span class="line">        margin-left: 8px;</span><br><span class="line">        color: #1677ff;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>当轮询触发更新操作时，展示弹框。</p>
<p>当id⼀致时，继续进行轮询操作</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722924049477.png" alt="1722924049477"></p>
<h4 id="继自实现方法的结构优化"><a href="#继自实现方法的结构优化" class="headerlink" title="继自实现方法的结构优化"></a>继自实现方法的结构优化</h4><p><code>index.html </code>替换掉原来的代码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">__client__version__</span> = <span class="string">&#x27;&lt;%= process.env.VUE_APP_SITE_VERSION %&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> _cookieKey = <span class="string">&#x27;accept_cookie_20211130&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改 <code>updateCheck.js </code>代码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UpdateModal</span> <span class="keyword">from</span> <span class="string">&#x27;./updateModal.vue&#x27;</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置定时器，每隔10分钟查询⼀次最新的 commit ID</span></span><br><span class="line">    <span class="built_in">setInterval</span>(fetchLatestCommitId, <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchLatestCommitId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;/v.txt&#x27;</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">newCommitId</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> currentCommitId = <span class="variable language_">window</span>.<span class="property">__client__version__</span></span><br><span class="line">        <span class="keyword">if</span> (currentCommitId &amp;&amp; newCommitId &amp;&amp; currentCommitId !== newCommitId) &#123;</span><br><span class="line">            <span class="comment">// 提⽰更新</span></span><br><span class="line">            <span class="title function_">showUpdateModal</span>(newCommitId)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showUpdateModal</span>(<span class="params">newCommitId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">UpdateModalComponent</span> = <span class="title class_">Vue</span>.<span class="title function_">extend</span>(<span class="title class_">UpdateModal</span>)</span><br><span class="line">    <span class="keyword">const</span> updateModalInstance = <span class="keyword">new</span> <span class="title class_">UpdateModalComponent</span>(&#123;</span><br><span class="line">        <span class="attr">propsData</span>: &#123; newCommitId &#125;,</span><br><span class="line">        <span class="attr">methods</span>: &#123;</span><br><span class="line">            <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.$destroy()</span><br><span class="line">                div.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(div)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_">refresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>(<span class="literal">true</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    updateModalInstance.$mount(div)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还原 <code>package.json</code> 的修改，新增 <code>vue.config.js</code> 相关代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; execSync &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)</span><br><span class="line"><span class="comment">// 获取当前Git仓库的短提交哈希，将其存储在cmtId变量中</span></span><br><span class="line"><span class="keyword">const</span> cmtId = <span class="title function_">execSync</span>(<span class="string">&#x27;git rev-parse --short HEAD&#x27;</span>).<span class="title function_">toString</span>().<span class="title function_">trim</span>()</span><br><span class="line"><span class="comment">// 将cmtId写⼊到public⽬录下的v.txt⽂件中</span></span><br><span class="line"><span class="keyword">const</span> versionFile = path.<span class="title function_">join</span>(process.<span class="title function_">cwd</span>(), <span class="string">&#x27;public&#x27;</span>, <span class="string">&#x27;v.txt&#x27;</span>)</span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(versionFile, cmtId)</span><br><span class="line">process.<span class="property">env</span>.<span class="property">VUE_APP_SITE_VERSION</span> = cmtId</span><br></pre></td></tr></table></figure>

<h4 id="方案缺陷-1"><a href="#方案缺陷-1" class="headerlink" title="方案缺陷"></a>方案缺陷</h4><ul>
<li>**使用第三方组件缺乏定制化:**可能无法完全满足定制化需求，或者与应用现有的架构和代码库不兼容。</li>
<li>**第三方组件生态问题:**基于较小团队开发，质量不稳定，缺乏完整的文档</li>
<li>**无法实时推送更新:**轮询方式可能导致更新提示的延迟，用户可能需要等待一段时间才能收到更新提示，而且并不能保证实时性。</li>
<li>**网络请求频繁:**每次轮询都需要进行网络请求来获取最新的commit id，即使 commit id没有发生变化。这会增加网络流量和服务器负担。</li>
</ul>
<h3 id="方案三-使用-Service-Worker拦截页面的网络请求"><a href="#方案三-使用-Service-Worker拦截页面的网络请求" class="headerlink" title="方案三 使用 Service Worker拦截页面的网络请求"></a>方案三 使用 <code>Service Worker</code>拦截页面的网络请求</h3><p><code>Service worker</code> 是一项浏览器技术，它可以在浏览器后台运行，拦截和处理网络请求。通过<code>Service Worker</code>，网站可以实现离线缓存、网络请求代理、推送通知等功能，提高用户体验和网站性能。<code>Service worker</code>是一个浏览器中的进程而不是浏览器内核下的线程，因此它在被注册安装之后能够被在多个页面中使用，也不会因为页面的关闭而被销毁。因此，<code>Service Worker</code> 很适合被用与多个页面需要使用的复杂数据的计算——购买一次，全家“收益”。</p>
<h4 id="基于-cli-plugin-pwa-插件的实现思路"><a href="#基于-cli-plugin-pwa-插件的实现思路" class="headerlink" title="基于 cli-plugin-pwa 插件的实现思路"></a>基于 <code>cli-plugin-pwa</code> 插件的实现思路</h4><h5 id="引入cli-plugin-pwa"><a href="#引入cli-plugin-pwa" class="headerlink" title="引入cli-plugin-pwa"></a>引入<code>cli-plugin-pwa</code></h5><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/vite-pwa/vite-plugin-pwa">https://github.com/vite-pwa/vite-plugin-pwa</a></p>
</blockquote>
<h5 id="在-src-registerServiceWorker-js-添加事件触发"><a href="#在-src-registerServiceWorker-js-添加事件触发" class="headerlink" title="在 src/registerServiceWorker.js 添加事件触发"></a>在 <code>src/registerServiceWorker.js</code> 添加事件触发</h5><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable no-console */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; register &#125; <span class="keyword">from</span> <span class="string">&quot;register-service-worker&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;production&quot;</span> &amp;&amp; navigator.<span class="property">serviceWorker</span>) &#123;</span><br><span class="line">    <span class="title function_">register</span>(<span class="string">`<span class="subst">$&#123;process.env.BASE_URL&#125;</span>service-worker.js`</span>, &#123;</span><br><span class="line">        <span class="title function_">ready</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                <span class="string">&quot;App is being served from cache by a service worker.\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;For more details, visit https://goo.gl/AFskqB&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="title function_">registered</span>(<span class="params">registration</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Service worker has been registered.&quot;</span>);</span><br><span class="line">            <span class="comment">// 通过测试新的服务⼯作线程来定期检查应⽤更新</span></span><br><span class="line">            <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                registration.<span class="title function_">update</span>();</span><br><span class="line">            &#125;, <span class="number">1000</span>); <span class="comment">// 这⾥为了测试 每秒检查⼀次</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">cached</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Content has been cached for offline use.&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updatefound</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;New content is downloading.&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 有个更新 通知⻚⾯更新</span></span><br><span class="line">        <span class="title function_">updated</span>(<span class="params">registration</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;New content is available; please refresh.&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建⼀个⾃定义事件</span></span><br><span class="line">            <span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;swupdatefound&quot;</span>, &#123; <span class="attr">detail</span>: registration &#125;);</span><br><span class="line">            <span class="comment">// 触发这个事件</span></span><br><span class="line">            <span class="variable language_">document</span>.<span class="title function_">dispatchEvent</span>(event);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">offline</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                <span class="string">&quot;No internet connection found. App is running in offline mode.&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">error</span>(<span class="params">error</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error during service worker registration:&quot;</span>, error);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> refreshing;</span><br><span class="line">    <span class="comment">// 监听需要更新事件 调⽤ window.location.reload()</span></span><br><span class="line">    navigator.<span class="property">serviceWorker</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;controllerchange&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (refreshing) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line"></span><br><span class="line">        refreshing = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="在页面中添加事件监听"><a href="#在页面中添加事件监听" class="headerlink" title="在页面中添加事件监听"></a>在页面中添加事件监听</h5><p>在 <code>main.js</code> 或 <code>store</code> 中添加事件监听</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 添加对应⾃定义事件的监听</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;swupdatefound&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 提⽰⽤⼾刷新</span></span><br><span class="line">    <span class="keyword">let</span> res = <span class="title function_">confirm</span>(<span class="string">&quot;新内容可⽤,请刷新&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="comment">// e.detail == registration</span></span><br><span class="line">        <span class="comment">// waiting.postMessage(&#123; type: &quot;SKIP_WAITING&quot; &#125;) 是固定写法</span></span><br><span class="line">        <span class="comment">// ⽤于触发更新 navigator.serviceWorker.addEventListener(&quot;controllerchange&quot;..</span></span><br><span class="line">        e.<span class="property">detail</span>.<span class="property">waiting</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;SKIP_WAITING&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ul>
<li><strong>离线支持:</strong> <code>Service Worker</code> 可以缓存页面资源，使得即使在离线状态下用户仍然可以访问应用，因此即使用户在没有网络连接的情况下打开页面，也能收到更新提示。</li>
<li>**即时更新提示:**当检测到新版本可用时，<code>Service Worker</code>可以立即向客户端发送更新提示，而无需等待客户端发起请求，从而能够及时通知用户有新版本可用。</li>
</ul>
<h4 id="方案缺陷-2"><a href="#方案缺陷-2" class="headerlink" title="方案缺陷"></a>方案缺陷</h4><ul>
<li>**兼容性问题:**出于对安全问题的考虑，Service Worker只能被使用在 <code>https </code>或者本地的<code>localhost </code>环境下。</li>
<li>**具有一定的理解和使用难度:**如果不正确地配置缓存策略，可能会导致 <code>Service Worker</code>无法正确地获取最新的资源，从而导致更新提示失败。</li>
<li>**资源占用问题:**接入 <code>service worker</code> 需要成本，本地运行一个 <code>worker</code> 也会占用内存和<code>cpu</code>资源。</li>
</ul>
<h3 id="方案四-基于WebSocket建立长期运行的连接"><a href="#方案四-基于WebSocket建立长期运行的连接" class="headerlink" title="方案四 基于WebSocket建立长期运行的连接"></a>方案四 基于<code>WebSocket</code>建立长期运行的连接</h3><p><code>Websocket</code>是一种协议，用于在 <code>Web</code> 应用程序中创建实时、双向的通信通道。<code>WebSocket</code>可以在浏览器和服务器之间建立一条双向通信的通道，实现服务器主动向浏览器推送消息，而无需浏览器向服务器不断发送请求。其原理是在浏览器和服务器之间建立一个“套接字”，通过“握手”的方式进行数据传输。由于该协议需要浏览器和服务器都支持，因此需要在应用程序中对其进行判断和处理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/kkirito16/ImgPicGo/img/1722924701316.png" alt="1722924701316"></p>
<h4 id="实现思路-1"><a href="#实现思路-1" class="headerlink" title="实现思路"></a>实现思路</h4><ol>
<li>建立 <code>WebSocket</code> 连接:在客户端，使用 <code>webSocket API</code> 建立与服务器的 <code>Websocket</code> 连接。当连接建立成功后，客户端将可以接收服务器发送的实时消息。</li>
<li>服务器推送消息: 当服务器检测到新版本可用时，向与客户端建立的 <code>webSocket</code> 连接发送更新提示消息。消息内容可以包括版本号、更新说明等信息。</li>
<li>客户端接收消息: 客户端通过监听 <code>webSocket </code>连接的消息事件，实时接收服务器发送的更新提示消息。</li>
<li>解析消息并提示用户: 客户端收到更新提示消息后，解析消息内容，并向用户显示更新提示。可以通过弹窗、通知栏等方式向用户提示有新版本可用，并提供刷新页面的选项。</li>
<li>用户操作:用户收到更新提示后，可以选择立即刷新页面以获取新版本，或者选择稍后刷新。</li>
<li>刷新页面: 如果用户选择立即刷新页面，客户端通过 <code>JavaScript</code> 脚本触发页面的刷新操作，使页面重新加载并获取最新版本的内容。</li>
<li>错误处理: 在实现过程中，需要考虑到网络连接中断、消息丢失等异常情况的处理，以确保系统的稳定性和可靠性。</li>
</ol>
<h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ul>
<li><strong>实时性:</strong> <code>WebSocket</code> 提供了双向实时通信的能力，可以立即将更新提示推送到客户端，使用户能够及时得知新版本的可用性，提高用户体验。</li>
<li><strong>高效性:</strong> <code>webSocket</code> 是基于 TCP 连接的，相比传统的 HTTP 请求，<code>WebSocket</code> 的通信开销更小，消息传输更高效，可以快速地将更新提示发送到客户端。</li>
</ul>
<h4 id="方案缺陷-3"><a href="#方案缺陷-3" class="headerlink" title="方案缺陷"></a>方案缺陷</h4><ul>
<li><strong>需要后端配合</strong></li>
<li>**服务器负担:**使用 <code>webSocket</code>进行实时通信会增加服务器的负担，特别是在用户量较大的情况下，可能会导致服务器压力过大。</li>
</ul>
<h2 id="方案比较-选择"><a href="#方案比较-选择" class="headerlink" title="方案比较&amp;选择"></a>方案比较&amp;选择</h2><p><em><strong>方案一&amp;方案二：</strong></em>方案二较之方案一，轮询加载<code>latest_commit_id.txt</code>比加载 <code>index.html</code>对服务器的压力更小，但都存在无法实时推送更新的问题</p>
<p><strong>方案三：</strong>虽然能解决无法及时实时推送更新的问题，但是会造成更大的资源占用，且使用和配置具有一定难度和复杂性，可能会引起其他缓存相关的问题<br><strong>方案四：</strong>需要一个<code>websocket</code>服务，且需要后端配合</p>
<p>考虑到平台的版本更新不会发生的很频繁且可以通过减少轮询周期来优化无法实时推送更新的问题，故<strong>综合考虑之下选择方案二</strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://ljqkkirito16.top">KKirito</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ljqkkirito16.top/2024/08/06/%E5%89%8D%E7%AB%AF%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%8F%90%E7%A4%BA%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94%E4%B8%8E%E5%AE%9E%E7%8E%B0/">https://ljqkkirito16.top/2024/08/06/%E5%89%8D%E7%AB%AF%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%8F%90%E7%A4%BA%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94%E4%B8%8E%E5%AE%9E%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ljqkkirito16.top" target="_blank">仰望星空时</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Markdown/">Markdown</a><a class="post-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/64e18125661c6c8e54c33269.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/06/%E4%BB%8ESSR%E5%88%B0ESR%E7%9A%84%E5%89%8D%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%96%B9%E5%BC%8F%E6%8E%A2%E7%B4%A2/" title="从SSR到ESR的前端渲染方式探索"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">从SSR到ESR的前端渲染方式探索</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/05/Ant%20Design%20Vue%20%E8%A7%A3%E5%86%B3%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%EF%BC%8B%E5%A4%9A%E9%80%89%E6%A1%86%E5%BC%95%E5%8F%91%E7%9A%84%E8%BE%93%E5%85%A5%E5%80%BC%E4%B8%8D%E7%94%9F%E6%95%88%E9%97%AE%E9%A2%98/" title="Ant Design Vue 解决表单验证＋多选框引发的输入值不生效问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ant Design Vue 解决表单验证＋多选框引发的输入值不生效问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/08/13/%E5%89%8D%E7%AB%AF%E7%AC%94%E8%AE%B0/" title="前端学习笔记（部分）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-13</div><div class="title">前端学习笔记（部分）</div></div></a></div><div><a href="/2024/08/05/Ant%20Design%20Vue%20%E8%A7%A3%E5%86%B3%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%EF%BC%8B%E5%A4%9A%E9%80%89%E6%A1%86%E5%BC%95%E5%8F%91%E7%9A%84%E8%BE%93%E5%85%A5%E5%80%BC%E4%B8%8D%E7%94%9F%E6%95%88%E9%97%AE%E9%A2%98/" title="Ant Design Vue 解决表单验证＋多选框引发的输入值不生效问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-05</div><div class="title">Ant Design Vue 解决表单验证＋多选框引发的输入值不生效问题</div></div></a></div><div><a href="/2024/08/06/Vue2.7.14%E4%B8%8B%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="Vue2.7.14下的单元测试环境搭建"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-06</div><div class="title">Vue2.7.14下的单元测试环境搭建</div></div></a></div><div><a href="/2024/08/06/%E4%BB%8ESSR%E5%88%B0ESR%E7%9A%84%E5%89%8D%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%96%B9%E5%BC%8F%E6%8E%A2%E7%B4%A2/" title="从SSR到ESR的前端渲染方式探索"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-06</div><div class="title">从SSR到ESR的前端渲染方式探索</div></div></a></div><div><a href="/2025/03/13/JS%E5%AE%9E%E7%8E%B0%E4%BB%BF%E4%BA%AC%E4%B8%9C%E9%A6%96%E9%A1%B5%E5%95%86%E5%93%81%E8%BD%AE%E6%92%AD%E5%9B%BE/" title="JS实现仿京东首页商品轮播图"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-13</div><div class="title">JS实现仿京东首页商品轮播图</div></div></a></div><div><a href="/2025/03/13/%E5%89%8D%E7%AB%AF%E5%93%8D%E5%BA%94%E5%BC%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="前端响应式的实现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-13</div><div class="title">前端响应式的实现</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/64e18125661c6c8e54c33269.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">KKirito</div><div class="author-info__description">无论暴风将我带到什么岸边，我都将以主人的身份上岸</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kkirito16"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kkirito16" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2021090917010@std.uestc.edu.cn" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #24292e;"></i></a><a class="social-icon" href="https://cdn.jsdelivr.net/gh/kkirito16/picgopicture/img/qq.jpg" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a><a class="social-icon" href="https://cdn.jsdelivr.net/gh/kkirito16/picgopicture/img/wechat.jpg" target="_blank" title="微信"><i class="fa-brands fa-weixin"></i></a><a class="social-icon" href="https://space.bilibili.com/171235920" target="_blank" title="bilibili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">更新了文章、背景图加载、评论系统。<br>追星的少年不会停下，只为寻得心中的那颗星，璀璨入心。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%8F%90%E7%A4%BA%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">前端版本更新提示技术方案调研与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">需求场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">主流实现方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80-%E9%80%9A%E8%BF%87-ETag-%E8%8E%B7%E5%8F%96%E5%BA%94%E7%94%A8%E7%89%88%E6%9C%AC"><span class="toc-number">1.3.1.</span> <span class="toc-text">方案一 通过 ETag 获取应用版本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ETag%E7%9A%84%E7%94%9F%E6%88%90"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">ETag的生成</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.1.1.1.</span> <span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BB%84%E4%BB%B6version-polling"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">相关第三方组件version-polling</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-%E9%80%9A%E8%BF%87-npm-%E5%BC%95%E5%85%A5%EF%BC%8C%E5%B9%B6%E9%80%9A%E8%BF%87%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E6%89%93%E5%8C%85"><span class="toc-number">1.3.1.2.2.1.</span> <span class="toc-text">方法一 通过 npm 引入，并通过构建工具进行打包</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-%E9%80%9A%E8%BF%87-script-%E5%BC%95%E2%BC%8A%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%8F%92%E2%BC%8A%E5%88%B0-HTML%EF%BC%88%E6%97%A0%E4%BE%B5%E5%85%A5%E7%94%A8%E6%B3%95%EF%BC%8C%E6%8E%A5%E5%85%A5%E6%88%90%E6%9C%AC%E6%9C%80%E4%BD%8E%EF%BC%89"><span class="toc-number">1.3.1.2.2.2.</span> <span class="toc-text">方法二 通过 script 引⼊，直接插⼊到 HTML（无侵入用法，接入成本最低）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E7%BC%BA%E9%99%B7"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">方案缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C-%E6%8F%90%E5%8F%96%E7%89%88%E6%9C%AC%E5%8F%B7%E4%BF%9D%E5%AD%98%E8%87%B3json%E6%96%87%E4%BB%B6%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BD%AE%E8%AF%A2%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">1.3.2.</span> <span class="toc-text">方案二 提取版本号保存至json文件，客户端轮询服务器上的版本号</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BB%84%E4%BB%B6-plugin-web-update-notification"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">相关第三方组件 plugin-web-update-notification</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E9%87%87%E7%94%A8vue-cli%E8%BF%9B%E8%A1%8C%E6%89%93%E5%8C%85"><span class="toc-number">1.3.2.1.2.</span> <span class="toc-text">基于项目的实践项目采用vue-cli进行打包</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">1.3.2.1.2.1.</span> <span class="toc-text">效果展示</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%9B%B4%E6%96%B0%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-number">1.3.2.1.2.2.</span> <span class="toc-text">检测更新的时机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">自实现方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.2.2.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">1.3.2.2.2.</span> <span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E8%87%AA%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E7%9A%84%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">继自实现方法的结构优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E7%BC%BA%E9%99%B7-1"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">方案缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%89-%E4%BD%BF%E7%94%A8-Service-Worker%E6%8B%A6%E6%88%AA%E9%A1%B5%E9%9D%A2%E7%9A%84%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="toc-number">1.3.3.</span> <span class="toc-text">方案三 使用 Service Worker拦截页面的网络请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-cli-plugin-pwa-%E6%8F%92%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">基于 cli-plugin-pwa 插件的实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5cli-plugin-pwa"><span class="toc-number">1.3.3.1.1.</span> <span class="toc-text">引入cli-plugin-pwa</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-src-registerServiceWorker-js-%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91"><span class="toc-number">1.3.3.1.2.</span> <span class="toc-text">在 src&#x2F;registerServiceWorker.js 添加事件触发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E9%A1%B5%E9%9D%A2%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="toc-number">1.3.3.1.3.</span> <span class="toc-text">在页面中添加事件监听</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9-1"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E7%BC%BA%E9%99%B7-2"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">方案缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%9B%9B-%E5%9F%BA%E4%BA%8EWebSocket%E5%BB%BA%E7%AB%8B%E9%95%BF%E6%9C%9F%E8%BF%90%E8%A1%8C%E7%9A%84%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">方案四 基于WebSocket建立长期运行的连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-1"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9-2"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E7%BC%BA%E9%99%B7-3"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">方案缺陷</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E6%AF%94%E8%BE%83-%E9%80%89%E6%8B%A9"><span class="toc-number">1.4.</span> <span class="toc-text">方案比较&amp;选择</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/13/%E5%89%8D%E7%AB%AF%E5%93%8D%E5%BA%94%E5%BC%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="前端响应式的实现">前端响应式的实现</a><time datetime="2025-03-13T12:24:43.854Z" title="发表于 2025-03-13 20:24:43">2025-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/13/JS%E5%AE%9E%E7%8E%B0%E4%BB%BF%E4%BA%AC%E4%B8%9C%E9%A6%96%E9%A1%B5%E5%95%86%E5%93%81%E8%BD%AE%E6%92%AD%E5%9B%BE/" title="JS实现仿京东首页商品轮播图">JS实现仿京东首页商品轮播图</a><time datetime="2025-03-13T12:10:23.222Z" title="发表于 2025-03-13 20:10:23">2025-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/06/Vue2.7.14%E4%B8%8B%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="Vue2.7.14下的单元测试环境搭建">Vue2.7.14下的单元测试环境搭建</a><time datetime="2024-08-06T06:25:26.160Z" title="发表于 2024-08-06 14:25:26">2024-08-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/06/%E4%BB%8ESSR%E5%88%B0ESR%E7%9A%84%E5%89%8D%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%96%B9%E5%BC%8F%E6%8E%A2%E7%B4%A2/" title="从SSR到ESR的前端渲染方式探索">从SSR到ESR的前端渲染方式探索</a><time datetime="2024-08-06T06:24:48.157Z" title="发表于 2024-08-06 14:24:48">2024-08-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/06/%E5%89%8D%E7%AB%AF%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%8F%90%E7%A4%BA%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="前端版本更新提示技术方案调研与实现">前端版本更新提示技术方案调研与实现</a><time datetime="2024-08-06T06:24:01.192Z" title="发表于 2024-08-06 14:24:01">2024-08-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By KKirito</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://ljqkkirito16.zeabur.app',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://ljqkkirito16.zeabur.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.textContent = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>